# ğŸ“¤ Instrukcja: WysyÅ‚anie plikÃ³w do Azure Blob Storage (PWA Backend)



Ten dokument opisuje sposÃ³b implementacji uploadu plikÃ³w z poziomu frontendowej aplikacji SPA (np. Vue/React) przy uÅ¼yciu backendowego API oraz Azure Blob Storage. ObsÅ‚ugiwane sÄ… zarÃ³wno **maÅ‚e pliki** (do ok. 250MB), jak i **duÅ¼e pliki** (do 4GB) poprzez **chunked upload z PutBlock/PutBlockList**.



---



## âœ… 1. Uzyskanie SAS URL do uploadu



WywoÅ‚aj endpoint backendu w celu otrzymania podpisanego linku SAS (Shared Access Signature), do ktÃ³rego frontend moÅ¼e bezpoÅ›rednio wrzuciÄ‡ plik do Azure.



### Endpoint:

```

GET /api/file/generate-upload-link?fileName={nazwaPliku}&contentType={mimeType}

```



### PrzykÅ‚ad:

```

GET /api/file/generate-upload-link?fileName=video.mp4&contentType=video/mp4

```



### OdpowiedÅº:

```json

{

&nbsp; "uploadUrl": "https://twojstorage.blob.core.windows.net/container/video.mp4?...sasToken..."

}

```



---



## ğŸ”¹ 2A. Upload maÅ‚ego pliku 



JeÅ›li plik jest niewielki, wystarczy **wysÅ‚aÄ‡ go w jednym zapytaniu PUT** na otrzymany `uploadUrl`.



```js

await fetch(uploadUrl, {

&nbsp; method: 'PUT',

&nbsp; headers: {

&nbsp;   'x-ms-blob-type': 'BlockBlob',

&nbsp;   'x-ms-version': '2020-10-02',

&nbsp;   'Content-Type': file.type

&nbsp; },

&nbsp; body: file

});

```



---



## ğŸ”¹ 2B. Upload duÅ¼ego pliku (chunking)



### ğŸ” PodziaÅ‚ pliku na fragmenty (np. 4MB)



```js

const CHUNK_SIZE = 4 * 1024 * 1024;

const blockIds = [];



for (let start = 0; start < file.size; start += CHUNK_SIZE) {

&nbsp; const end = Math.min(file.size, start + CHUNK_SIZE);

&nbsp; const chunk = file.slice(start, end);

&nbsp; const blockId = btoa(String(start).padStart(6, '0')); // base64 ID

&nbsp; blockIds.push(blockId);



&nbsp; const chunkUrl = `${uploadUrl}&comp=block&blockid=${encodeURIComponent(blockId)}`;



&nbsp; await fetch(chunkUrl, {

&nbsp;   method: 'PUT',

&nbsp;   headers: {

&nbsp;     'x-ms-blob-type': 'BlockBlob',

&nbsp;     'x-ms-version': '2020-10-02',

&nbsp;     'Content-Type': file.type

&nbsp;   },

&nbsp;   body: chunk

&nbsp; });

}

```



---



### ğŸ§± ZakoÅ„czenie uploadu â€“ `PutBlockList`



Po wysÅ‚aniu wszystkich blokÃ³w naleÅ¼y zakoÅ„czyÄ‡ upload przez przesÅ‚anie listy blockÃ³w:



```js

const blockListXml = `

<BlockList>

&nbsp; ${blockIds.map(id => `<Latest>${id}</Latest>`).join('')}

</BlockList>

`;



await fetch(`${uploadUrl}&comp=blocklist`, {

&nbsp; method: 'PUT',

&nbsp; headers: {

&nbsp;   'x-ms-version': '2020-10-02',

&nbsp;   'Content-Type': 'application/xml'

&nbsp; },

&nbsp; body: blockListXml

});

```



---



## âœ… 3. Potwierdzenie uploadu w backendzie (`/commit`)



Po zapisaniu pliku w Azure, frontend musi **poinformowaÄ‡ backend**, aby zapisaÄ‡ metadane.



### Endpoint:

```

POST /api/file/commit

```



### Payload:

```json

{

&nbsp; "fileName": "video.mp4",

&nbsp; "mimeType": "video/mp4",

&nbsp; "size": 4294967296,

&nbsp; "blobUri": "https://twojstorage.blob.core.windows.net/container/video.mp4",

&nbsp; "uploadTimestamp": "2025-07-29T18:00:00Z"

}

```



- Pole `userId` nie jest wymagane â€“ backend pobierze je z JWT.



---



## â„¹ï¸ Uwagi koÅ„cowe



- Wszystkie pliki uploadowane sÄ… **bezpoÅ›rednio do Azure**, bez obciÄ…Å¼ania backendu.

- Backend:

&nbsp; - generuje bezpieczny link SAS do uploadu

&nbsp; - przyjmuje metadane po zakoÅ„czeniu

- Frontend:

&nbsp; - wysyÅ‚a plik (PUT)

&nbsp; - w przypadku duÅ¼ych â€“ dzieli plik i wysyÅ‚a chunkami

&nbsp; - koÅ„czy upload przez `PutBlockList`

&nbsp; - wywoÅ‚uje endpoint `/commit`



---



## ğŸ› ï¸ Debugowanie



- JeÅ›li plik nie pojawia siÄ™ w Azure: upewnij siÄ™, Å¼e uÅ¼yto `PutBlockList`.

- JeÅ›li metadane siÄ™ nie zapisujÄ… â€“ sprawdÅº token JWT i czy commit zostaÅ‚ poprawnie wysÅ‚any.




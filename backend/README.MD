# ğŸ“¤ Instrukcja: WysyÅ‚anie plikÃ³w do Azure Blob Storage (PWA Backend)



Ten dokument opisuje sposÃ³b implementacji uploadu plikÃ³w z poziomu frontendowej aplikacji SPA (np. Vue/React) przy uÅ¼yciu backendowego API oraz Azure Blob Storage. ObsÅ‚ugiwane sÄ… zarÃ³wno **maÅ‚e pliki**, jak i **duÅ¼e pliki** (do 4GB) poprzez **chunked upload z PutBlock/PutBlockList**.



---



## âœ… 1. Uzyskanie SAS URL do uploadu



WywoÅ‚aj endpoint backendu w celu otrzymania podpisanego linku SAS (Shared Access Signature), do ktÃ³rego frontend moÅ¼e bezpoÅ›rednio wrzuciÄ‡ plik do Azure.



### Endpoint:

```

GET /api/file/generate-upload-link

```


### Payload:
```json
{
  "fileName": "video.mp4",
  "mimeType": "video/mp4",
  "expectedSize": 4294967296
}
```



### OdpowiedÅº:

```json

{
  "fileId": "c8a6c6e5-3f32-4d56-9c62-abc123...",
  "uploadUrl": "https://twojstorage.blob.core.windows.net/container/{userId}/{fileId}/video.mp4?...sasToken..."
}

```



---



## ğŸ”¹ 2A. Upload maÅ‚ego pliku 



JeÅ›li plik jest niewielki, wystarczy **wysÅ‚aÄ‡ go w jednym zapytaniu PUT** na otrzymany `uploadUrl`.



```js

await fetch(uploadUrl, {

 method: 'PUT',

 headers: {

   'x-ms-blob-type': 'BlockBlob',

   'x-ms-version': '2020-10-02',

   'Content-Type': file.type

 },

 body: file

});

```



---



## ğŸ”¹ 2B. Upload duÅ¼ego pliku (chunking)
```

Azure wymaga, aby block ID byÅ‚o Base64 oraz tej samej dÅ‚ugoÅ›ci dla wszystkich blokÃ³w. 
NaleÅ¼y je zero-padâ€™owaÄ‡ przed konwersjÄ… btoa.
```


### ğŸ” PodziaÅ‚ pliku na fragmenty (np. 4MB)



```js

const CHUNK_SIZE = 4 * 1024 * 1024;

const blockIds = [];



for (let start = 0; start < file.size; start += CHUNK_SIZE) {

 const end = Math.min(file.size, start + CHUNK_SIZE);

 const chunk = file.slice(start, end);

 const blockId = btoa(String(start).padStart(6, '0')); // base64 ID

 blockIds.push(blockId);



 const chunkUrl = `${uploadUrl}&comp=block&blockid=${encodeURIComponent(blockId)}`;



 await fetch(chunkUrl, {

   method: 'PUT',

   headers: {

     'x-ms-blob-type': 'BlockBlob',

     'x-ms-version': '2020-10-02',

     'Content-Type': file.type

   },

   body: chunk

 });

}

```



---



### ğŸ§± ZakoÅ„czenie uploadu â€“ `PutBlockList`



Po wysÅ‚aniu wszystkich blokÃ³w naleÅ¼y zakoÅ„czyÄ‡ upload przez przesÅ‚anie listy blockÃ³w:



```js

const blockListXml = `

<BlockList>

 ${blockIds.map(id => `<Latest>${id}</Latest>`).join('')}

</BlockList>

`;



await fetch(`${uploadUrl}&comp=blocklist`, {

 method: 'PUT',

 headers: {

   'x-ms-version': '2020-10-02',

   'Content-Type': 'application/xml'

 },

 body: blockListXml

});

```



---



## âœ… 3. Potwierdzenie uploadu w backendzie (`/commit`)



Po zapisaniu pliku w Azure, frontend musi **poinformowaÄ‡ backend**, aby zapisaÄ‡ metadane.



### Endpoint:

```

POST /api/file/commit

```



### Payload:

```json

{
  "fileId": "c8a6c6e5-3f32-4d56-9c62-abc123...",
  "mimeType": "video/mp4",
  "size": 4294967296,
  "checksum": "Opcjonalnie_MD5_Base64"
}

```


- checksum jest polem opcjonalnym (moÅ¼e byÄ‡ pominiÄ™te). 
- NA RAZIE NIE WYSYÅAJCIE checksum, zadziaÅ‚a bez:)
- Pole `userId` nie jest wymagane â€“ backend pobierze je z JWT.

### OdpowiedÅº
```
{
  "message": "Upload committed",
  "fileId": "c8a6c6e5-3f32-4d56-9c62-abc123..."
}
```

---

---

## ğŸ“„ 4. Pobieranie listy plikÃ³w uÅ¼ytkownika

Po zalogowaniu uÅ¼ytkownik moÅ¼e pobraÄ‡ listÄ™ wszystkich swoich plikÃ³w zapisanych w bazie (metadane) + pliki wspÃ³Å‚dzielone.

### Endpoint:

```

GET /api/files

```
### Parametry zapytania:

```
| Parametr        | Typ    | DomyÅ›lnie         | Opis                                                                                      |
| --------------- | ------ | ----------------- | ----------------------------------------------------------------------------------------- |
| `page`          | number | `1`               | Numer strony (min. 1)                                                                     |
| `pageSize`      | number | `20`              | Rozmiar strony (1â€“100)                                                                    |
| `sortBy`        | string | `uploadTimestamp` | Pole sortowania (patrz niÅ¼ej)                                                             |
| `sortDirection` | string | `desc`            | Kierunek: `asc` lub `desc`                                                                |
| `q`             | string | null              | Fraza wyszukiwania (szuka w `fileName`, `mimeType`, `ownerName` â€“ o ile jest w projekcji) |



Dozwolone wartoÅ›ci sortBy:

- uploadTimestamp

- fileName

- mimeType

- size


Nieznana wartoÅ›Ä‡ sortBy â†’ fallback do uploadTimestamp.

```

### PrzykÅ‚ad: paginacja i sortowanie po nazwie rosnÄ…co

```
GET /api/file?page=1&pageSize=10&sortBy=fileName&sortDirection=asc
```

### OdpowiedÅº:
```json
[
  {
  "items": [
    {
      "id": "94a3b2f0-...-...",
      "fileName": "video.mp4",
      "mimeType": "video/mp4",
      "size": 4294967,
      "uploadTimestamp": "2025-09-28T12:34:56Z",
      "userId": "4c71cf03-30f3-4afb-6d24-08ddd0d773a0",
      "ownerName": "demoUser"
    }
  ],
  "page": 1,
  "pageSize": 10,
  "totalItems": 1,
  "totalPages": 1,
  "hasNext": false,
  "hasPrev": false,
  "sortBy": "fileName",
  "sortDir": "asc",
  "q": ""
}

]
```
---

## ğŸ“¥ 5. Pobranie pliku z metadanymi i linkiem SAS

Po klikniÄ™ciu w plik na liÅ›cie, frontend moÅ¼e pobraÄ‡ szczegÃ³Å‚owe informacje o pliku oraz tymczasowy link do pobrania z Azure (SAS URL).
Link wygasa po okreÅ›lonym czasie (np. 10 minut).

### Endpoint:

```

GET /api/files/{id}

```

{id} â€“ identyfikator pliku z bazy (pole id z listy plikÃ³w).

### OdpowiedÅº:
```json
[
  {
  "id": "8f3d1e5a-0b1c-4a6f-9f89-2d12a8ffb64f",
  "fileName": "video.mp4",
  "mimeType": "video/mp4",
  "size": 4294967296,
  "uploadTimestamp": "2025-07-29T18:00:00Z",
  "downloadUrl": "https://twojstorage.blob.core.windows.net/container/video.mp4?...sasToken...",
  "expiresInSeconds": 600,
   "userId": "id",
   "ownerName": "username"
   }
]
```
Jak uÅ¼yÄ‡ downloadUrl:
MoÅ¼esz wstawiÄ‡ go bezpoÅ›rednio jako src w ```<video>```, ```<img>```, ```<audio>``` lub pobraÄ‡ go przez fetch/axios.

PrzykÅ‚ad â€“ odtworzenie wideo:

```
<video controls src="{downloadUrl}"></video>
```
PrzykÅ‚ad â€“ pobranie pliku w JS:
```
window.location.href = downloadUrl;
```

WaÅ¼ne: Po wygaÅ›niÄ™ciu linku (expiresInSeconds) trzeba ponownie wywoÅ‚aÄ‡ ten endpoint, aby pobraÄ‡ nowy SAS URL.


## â„¹ï¸ Uwagi koÅ„cowe



- Wszystkie pliki uploadowane sÄ… **bezpoÅ›rednio do Azure**, bez obciÄ…Å¼ania backendu.

- Backend:

 - generuje bezpieczny link SAS do uploadu

 - przyjmuje metadane po zakoÅ„czeniu

- Frontend:

 - wysyÅ‚a plik (PUT)

 - w przypadku duÅ¼ych â€“ dzieli plik i wysyÅ‚a chunkami

 - koÅ„czy upload przez `PutBlockList`

 - wywoÅ‚uje endpoint `/commit`



---



## ğŸ› ï¸ Debugowanie



- JeÅ›li plik nie pojawia siÄ™ w Azure: upewnij siÄ™, Å¼e uÅ¼yto `PutBlockList`.

- JeÅ›li metadane siÄ™ nie zapisujÄ… â€“ sprawdÅº token JWT i czy commit zostaÅ‚ poprawnie wysÅ‚any.



